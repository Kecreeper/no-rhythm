/*
First time? Check out the tutorial game:
https://sprig.hackclub.com/gallery/getting_started

@title: No Rhythm
@author: Eduardo
@tags: []
@addedOn: 2024-00-00
*/

const player = "p"
const blackPixel = "b"
const yellowPixel = "y"
const redPixel = "r"

setLegend(
  [player, bitmap`
................
................
................
................
................
................
................
................
066..........6F0
066..........6F0
066..........6F0
0F66........6FF0
.0F66......66F0.
..0F6666666FF0..
...0FFFFFFFF0...
....00000000....`],
  [yellowPixel, bitmap`
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666`],
  [blackPixel, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000`],
  [redPixel, bitmap`
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333`]
)


let level = 0
const levels = [
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................bbb.............................
............................b...b............................
...........................b.....b...........................
...........................b.....b...........................
...........................b.....b...........................
............................b...b............................
.............................bbb.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................bbb.............................
............................b...b............................
...........................b.....b...........................
...........................b..r..b...........................
...........................b.....b...........................
............................b...b............................
.............................bbb.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................bbb.............................
............................b...b............................
...........................b..r..b...........................
...........................b.rrr.b...........................
...........................b..r..b...........................
............................b...b............................
.............................bbb.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................bbb.............................
............................b...b............................
...........................b.rrr.b...........................
...........................b.rrr.b...........................
...........................b.rrr.b...........................
............................b...b............................
.............................bbb.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................bbb.............................
............................b.r.b............................
...........................b.rrr.b...........................
...........................brrrrrb...........................
...........................b.rrr.b...........................
............................b.r.b............................
.............................bbb.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................bbb.............................
............................brr.b............................
...........................brrrr.b...........................
...........................brrrrrb...........................
...........................b.rrrrb...........................
............................b.rrb............................
.............................bbb.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................bbb.............................
............................brrrb............................
...........................brrrrrb...........................
...........................brrrrrb...........................
...........................brrrrrb...........................
............................brrrb............................
.............................bbb.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................rbb.............................
............................brrrr............................
...........................brrrrrr...........................
...........................rrrrrrb...........................
...........................brrrrrb...........................
............................brrrr............................
.............................rbb.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
  map`
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................rrr.............................
............................rrrrr............................
...........................rrrrrrr...........................
...........................rrrrrrr...........................
...........................rrrrrrr...........................
............................rrrrr............................
.............................rrr.............................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................
.............................................................`,
]

setMap(levels[level])

function drawX(xTable, y, pixel, offset) {
  if (offset == null){
    offset = [0, 0]
  }
  
  let x1 = xTable[0] + offset[0]
  let x2 = xTable[1] + offset[0]
  y = y + offset[1]
  let xLength = x2 - x1 + 1

  for (i = 0; i < xLength; i++) {
    addSprite(x1+i, y, pixel)
  }
}

function drawY(x, yTable, pixel, offset) {
  if (offset == null){
    offset = [0, 0]
  }
  
  let y1 = yTable[0] + offset[1]
  let y2 = yTable[1] + offset[1]
  x = x + offset[0]
  let yLength = y2 - y1 + 1

  for (i = 0; i < yLength; i++) {
    addSprite(x, y1+i, pixel)
  }
}

function addSprite2(x, y, pixel, offset){
  if (offset == null){
    offset = [0, 0]
  }

  addSprite(x + offset[0], y + offset[1], pixel)
}

/*
function getTilesX(xTable, y, offset) {
  if (offset == null){
    offset = [0, 0]
  }

  let x1 = xTable[0] + offset[0]
  let x2 = xTable[1] + offset[0]
  y = y + offset[1]
  let xLength = x2 - x1 + 1

  let tiles = []
  for (let i = 0; i < xLength; i++) {
    tiles.push(getTile(x1+i, y)[0])
  }
  return tiles
}
*/

function getTilesY(x, yTable, offset) {
  if (offset == null){
    offset = [0, 0]
  }
  
  let y1 = yTable[0] + offset[1]
  let y2 = yTable[1] + offset[1]
  x = x + offset[0]
  let yLength = y2 - y1 + 1
  
  let tiles = []
  for (let i = 0; i < yLength; i++) {
    tiles.push(getTile(x, y1+i)[0])
  }
  return tiles
}

function getTile2(x, y, offset, pixel) {
  if (offset == null){
    offset = [0, 0]
  }
  if (pixel == null) {
    return getTile(x + offset[0], y + offset[1])
  }

  let tilesTable = getTile(x + offset[0], y + offset[1])
  for (let i = 0; i < tilesTable.length; i++) {
    if (tilesTable[i].type == pixel.type) {
      return tilesTable[i]
    }
  }
}

let directions = ["up", "down", "left", "right"]

function getPoints(offset) {
  if (offset == null){
    offset = [0, 0]
  }
  
  let table1 = getTilesY(28, [29,31], offset)
  let table2 = getTilesY(29, [28,32], offset)
  let table3 = getTilesY(30, [28,32], offset)
  let table4 = getTilesY(31, [28,32], offset)
  let table5 = getTilesY(32, [29,31], offset)

  let tiles = table1.concat(table2, table3, table4, table5)
  console.log(tiles)
  console.log(tiles.length)
  let finalTiles = []

  for (let i = 0; i < tiles.length; i++) {
    if (typeof(tiles[i]) != 'undefined' && tiles[i].type === yellowPixel) {
      finalTiles.push(tiles[i])
    }
  }
  
  return finalTiles
}

function countPixels(table) {
  var count = 0
  
  for (i=0;i<table.length;i++) {
    if (table[i] != null) {
      count += 1
    }
  }
  
  return count
}

function deletePixels(table, pixel, truefalse) {
  for (i = 0; i < table.length ; i++) {
    let pixelInTable = table[i]
    
    if (pixelInTable.type === pixel) {
      const spritesInTile = getTile(pixelInTable.x, pixelInTable.y)
      for (j = 0; j < spritesInTile.length; j++) {
        if (spritesInTile[j].type === pixelInTable.type) {
          spritesInTile[j].remove()
        }
      }
    }
  }
  if (truefalse == true) {fallingCircles.splice(fallingCircles.indexOf(table), 1)}
}

function makeCircle(pixel, offset) {
  if (offset == null){
    offset = [0, 0]
  }

  drawY(27, [29, 31], pixel, offset) // left line
  addSprite2(28, 28, pixel, offset)
  
  drawY(33, [29, 31], pixel, offset) // right line
  addSprite2(32, 32, pixel, offset)

  drawX([29, 31], 27, pixel, offset) // top line
  addSprite2(32, 28, pixel, offset)
  
  drawX([29, 31], 33, pixel, offset)// bottom line
  addSprite2(28, 32, pixel, offset)

  
  let table1 = [
    getTile2(28, 28, offset)[0],
    getTile2(32, 32, offset)[0],
    getTile2(32, 28, offset)[0],
    getTile2(28, 32, offset)[0],
  ]
  let table2 = getTilesX([29, 31], 27, offset)
  let table3 = getTilesX([29, 31], 33, offset)
  let table4 = getTilesY(27, [29, 31], offset)
  let table5 = getTilesY(33, [29, 31], offset)
  
  let finalTable = table1.concat(table2, table3, table4, table5)
  return finalTable
}

function makeInnerCircle(pixel, offset) {
  if (offset == null){
    offset = [0, 0]
  }
  
  drawY(28, [29,31], pixel, offset)
  drawY(29, [28,32], pixel, offset)
  drawY(30, [28,32], pixel, offset)
  drawY(31, [28,32], pixel, offset)
  drawY(32, [29,31], pixel, offset)

  let table1 = getTilesY(28, [29,31], offset)
  let table2 = getTilesY(29, [28,32], offset)
  let table3 = getTilesY(30, [28,32], offset)
  let table4 = getTilesY(31, [28,32], offset)
  let table5 = getTilesY(32, [29,31], offset)

  let finalTable = table1.concat(table2, table3, table4, table5)
  return finalTable
}

let maxDistance = 34

function randomDirectionCircle(string) {
  if (string == "up") {
    let circle = makeInnerCircle(yellowPixel, [0, -27])
    circle.direction = "up"
    circle.distance = maxDistance
    circle.traveled = 0
    return circle
    
  } else if (string == "down") {
    let circle = makeInnerCircle(yellowPixel, [0, 27])
    circle.direction = "down"
    circle.distance = maxDistance
    circle.traveled = 0
    return circle
    
  } else if (string == "left") {
    let circle = makeInnerCircle(yellowPixel, [-27, 0])
    circle.direction = "left"
    circle.distance = maxDistance
    circle.traveled = 0
    return circle
    
  } else if (string == "right") {
    let circle = makeInnerCircle(yellowPixel, [27, 0])
    circle.direction = "right"
    circle.distance = maxDistance
    circle.traveled = 0
    return circle
  }
}



/*
function fallDown(table) {
  let count = 1

  for (let i = 0; i < count; i++){
    moveDown(table, 1)
  }
}
*/

function moveRight(table, magnitude){
  if (table.traveled == table.distance) {
    fallingCircles.splice(fallingCircles.indexOf(table), 1)
    deletePixels(table, yellowPixel)
    return
  }
  table.traveled += 1
  for (let i = 0; i < table.length; i++){
    table[i].x += magnitude
  }
}

function moveLeft(table, magnitude){
  if (table.traveled == table.distance) {
    fallingCircles.splice(fallingCircles.indexOf(table), 1)
    deletePixels(table, yellowPixel)
    return
  }
  table.traveled += 1
  for (let i = 0; i < table.length; i++){
    table[i].x -= magnitude
  }
}

function moveUp(table, magnitude){
  if (table.traveled == table.distance) {
    fallingCircles.splice(fallingCircles.indexOf(table), 1)
    deletePixels(table, yellowPixel)
    return
  }
  table.traveled += 1
  for (let i = 0; i < table.length; i++){
    table[i].y -= magnitude
  }
}

function moveDown(table, magnitude){
  if (table.traveled == table.distance) {
    fallingCircles.splice(fallingCircles.indexOf(table), 1)
    deletePixels(table, yellowPixel)
    return
  }
  table.traveled += 1
  for (let i = 0; i < table.length; i++){
    table[i].y += magnitude
  }
}

// let blackCircle = makeCircle(blackPixel)
// let yellowCircle = makeCircle(yellowPixel, [0, -27])

let fallingCircles = []


function circleHandler(table, magnitude) {
  if (table.direction == "up") {
    moveDown(table, magnitude)
  } else if (table.direction == "down") {
    moveUp(table, magnitude)
  } else if (table.direction == "left") {
    moveRight(table, magnitude)
  } else if (table.direction == "right") {
    moveLeft(table, magnitude)
  } 
}

function getRndInteger(min, max) {
  return Math.floor(Math.random() * (max - min + 1) ) + min;
}

var score = 0

var damage = 0

addText( score.toString(), { 
  x: 3,
  y: 1,
  color: color`3`
})

let innerCircleAmount = 21

function back1Level() {
  if (damage <= 18) {
    damage = 0
  } else {
    damage -= 18
  }
}

onInput("d", function(){
  let points = getPoints()
  let count = countPixels(points)
  score += count*100
  deletePixels(fallingCircles[0], yellowPixel, true)

  let amountNotScored = innerCircleAmount - count
  if (amountNotScored == 0) {
    back1Level()
  }
  
  damage += amountNotScored
})

afterInput(function() {
  clearText()

  if (damage >= 18 && damage < 36) {
    level = 1
  } else if (damage >= 36 && damage < 54) {
    level = 2
  } else if (damage >= 54 && damage < 72) {
    level = 3
  } else if (damage >= 72 && damage < 90) {
    level = 4
  } else if (damage >= 90 && damage < 108) {
    level = 5
  } else if (damage >= 108 && damage < 126) {
    level = 6
  }

  setMap(levels[level])
  
  addText( score.toString(), { 
    x: 3,
    y: 1,
    color: color`3`
  })
})

function moveLoop() {
  for (let i = 0; i < fallingCircles.length; i++) {
    circleHandler(fallingCircles[i], 1)
  }
}

function spawnLoop() {
  let index = getRndInteger(0, 3)
  
  fallingCircles.push(
    randomDirectionCircle(
      directions[index]
    )
  )
  setTimeout(spawnLoop, getRndInteger(1500, 2500))
}

function gameLoop() {
  moveLoop()
  setTimeout(gameLoop, 1000 / 30)
}

function startGame() {
  spawnLoop()
  gameLoop()
}

startGame()